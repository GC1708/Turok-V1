local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- UI Setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AimLockUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local aimButton = Instance.new("ImageButton")
aimButton.Name = "AimLockButton"
aimButton.Size = UDim2.new(0, 50, 0, 50)
aimButton.Position = UDim2.new(1, -60, 0.5, -25)
aimButton.BackgroundTransparency = 1
aimButton.Image = "rbxassetid://7411011041"
aimButton.Parent = screenGui

local uiCorner = Instance.new("UICorner")
uiCorner.CornerRadius = UDim.new(1, 0)
uiCorner.Parent = aimButton

-- State
local aimLockEnabled = false

-- Toggle logic
aimButton.MouseButton1Click:Connect(function()
	aimLockEnabled = not aimLockEnabled
	aimButton.ImageColor3 = aimLockEnabled and Color3.fromRGB(255, 80, 80) or Color3.new(1, 1, 1)
end)

-- Get target closest to camera center
local function getTargetByCameraLook()
	local bestTarget = nil
	local smallestAngle = math.huge

	for _, player in ipairs(Players:GetPlayers()) do
		if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Head") then
			local head = player.Character.Head
			local directionToHead = (head.Position - Camera.CFrame.Position).Unit
			local cameraLookVector = Camera.CFrame.LookVector

			local dot = directionToHead:Dot(cameraLookVector)
			local angle = math.acos(math.clamp(dot, -1, 1)) -- radians

			-- Raycast for visibility
			local distance = (head.Position - Camera.CFrame.Position).Magnitude
			local rayParams = RaycastParams.new()
			rayParams.FilterType = Enum.RaycastFilterType.Blacklist
			rayParams.FilterDescendantsInstances = {LocalPlayer.Character}

			local result = workspace:Raycast(Camera.CFrame.Position, directionToHead * distance, rayParams)

			if (not result or result.Instance:IsDescendantOf(player.Character)) and angle < smallestAngle then
				smallestAngle = angle
				bestTarget = player
			end
		end
	end

	if bestTarget and bestTarget.Character then
		return bestTarget.Character:FindFirstChild("Head")
	end
	return nil
end

-- Auto-aim loop
RunService.RenderStepped:Connect(function()
	if aimLockEnabled then
		local head = getTargetByCameraLook()
		if head then
			Camera.CFrame = CFrame.lookAt(Camera.CFrame.Position, head.Position)
		end
	end
end)
